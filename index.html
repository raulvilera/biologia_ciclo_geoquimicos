<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>ATIVIDADE BIOLOGIA (3º Bimestre) - E.E. LYDIA KITZ MOREIRA</title>
<style>
  *{box-sizing:border-box;margin:0;padding:0;font-family:'Segoe UI',Tahoma,Arial;}
  body{background:linear-gradient(90deg,#c0c0c0,#a9a9a9);padding:20px;color:#222}
  .container{max-width:1000px;margin:0 auto}
  header{background:linear-gradient(90deg,#1a2980,#26d0ce);color:#fff;padding:20px;border-radius:10px;margin-bottom:18px}
  .school-name{font-size:20px;font-weight:700}
  .activity-title{font-size:22px;text-align:center;margin:12px 0;text-transform:uppercase}
  .student-info{display:grid;grid-template-columns:1fr 1fr;gap:12px;margin-top:12px}
  .info-group{display:flex;flex-direction:column}
  label{font-weight:700;margin-bottom:6px}
  input,select,button{padding:10px;border-radius:6px;border:none}
  input,select{background:rgba(255,255,255,0.95)}
  .question-container{background:linear-gradient(90deg,#1a2980,#26d0ce);padding:16px;border-radius:10px;margin-bottom:14px;color:#fff}
  .question{background:rgba(255,255,255,0.08);padding:12px;border-radius:8px}
  .question-text{font-weight:700;margin-bottom:8px}
  .options{display:grid;gap:8px;margin-top:8px}
  .option{background:rgba(255,255,255,0.12);padding:8px;border-radius:6px;cursor:pointer}
  .option input{margin-right:10px}
  .buttons{display:flex;justify-content:center;margin:16px 0}
  button{background:linear-gradient(90deg,#1a2980,#26d0ce);color:#fff;font-weight:700;cursor:pointer}
  .results{display:none;background:linear-gradient(90deg,#1a2980,#26d0ce);color:#fff;padding:16px;border-radius:10px;margin-top:12px}
  .score{font-size:20px;font-weight:700;margin-bottom:8px}
  .feedback{margin-top:8px;text-align:left}
  .correct{color:#7fff00;font-weight:700}
  .incorrect{color:#ffb3a7;font-weight:700}
  .loading{display:none;text-align:center;margin:12px 0}
  .spinner{width:30px;height:30px;border-radius:50%;border:4px solid rgba(255,255,255,0.25);border-top:4px solid #26d0ce;animation:spin 1s linear infinite;margin:0 auto}
  @keyframes spin{0%{transform:rotate(0)}100%{transform:rotate(360deg)}}
  @media(max-width:768px){.student-info{grid-template-columns:1fr}}
</style>
</head>
<body>
<div class="container">
  <header>
    <div class="school-name">E.E. LYDIA KITZ MOREIRA</div>

    <div class="student-info" style="margin-top:12px">
      <div class="info-group">
        <label for="student-name">NOME:</label>
        <select id="student-name">
          <option value="">Selecione seu nome</option>
        </select>
      </div>

      <div class="info-group">
        <label for="student-number">Nº:</label>
        <input id="student-number" readonly />
      </div>

      <div class="info-group">
        <label for="student-grade">SÉRIE:</label>
        <input id="student-grade" value="1ª Série" readonly />
      </div>

      <div class="info-group">
        <label for="student-email">E-mail institucional:</label>
        <input id="student-email" readonly />
      </div>
    </div>

    <div class="activity-title">ATIVIDADE DE BIOLOGIA (3º BIMESTRE)</div>
    <div style="text-align:center;color:#eaf8ff;margin-top:6px">"REVISÃO DOS TEMAS"</div>
  </header>

  <div id="questions-container"></div>

  <div class="loading" id="loading">
    <div class="spinner"></div>
    <p style="color:#222;margin-top:8px">Enviando respostas, aguarde...</p>
  </div>

  <div class="buttons">
    <button id="submit-btn">Enviar Respostas</button>
  </div>

  <div id="results" class="results">
    <div class="score">Sua pontuação: <span id="score-value">0</span>/10</div>
    <div id="feedback" class="feedback"></div>
  </div>
</div>

<script>
/*
  FRONTEND sem gabarito embutido.
  - Todas as questões têm 'id', 'question', 'options' e 'explanation'
  - NÃO há propriedade 'correct' aqui (gabarito deve ficar no backend).
  - Ao enviar, o frontend manda JSON ao backend e aguarda resposta JSON com:
      { status: "OK", score: N, details: [ { id: 1, correct: true/false, explanation: "..." }, ... ] }
    ou, caso o backend não retorne JSON, faz fallback para mensagem textual.
*/

/* === LISTA COMPLETA DE ALUNOS (copiada do seu primeiro código) === */
const students = [
 { id: 1, name: "ALEXANDRE BATISTA DOS SANTOS", email: "00001141439785SP@al.educacao.sp.gov.br" },
 { id: 5, name: "ANA LÍVIA BRAGA DOS SANTOS", email: "00001122248246SP@al.educacao.sp.gov.br" },
 { id: 7, name: "ARTHUR CASTRO SILVA", email: "00001122238228SP@al.educacao.sp.gov.br" },
 { id: 11, name: "DANIELLE OLIVEIRA DA SILVA NUNES", email: "00001122096756SP@al.educacao.sp.gov.br" },
 { id: 14, name: "ELOYSA ANDRADE OLIVEIRA SILVA", email: "00001103565242SP@al.educacao.sp.gov.br" },
 { id: 18, name: "FELIPE MARCONDES SILVA", email: "0000112225538XSP@al.educacao.sp.gov.br" },
 { id: 19, name: "GEOVANA FERREIRA DA SILVA SOUZA", email: "00001111268939SP@al.educacao.sp.gov.br" },
 { id: 20, name: "GEOVANNA GABRIELA PIERRE SILVA", email: "00001122198954SP@al.educacao.sp.gov.br" },
 { id: 24, name: "ISAAK ALVAREZ MARQUEZ CAETANO", email: "00001141664471SP@al.educacao.sp.gov.br" },
 { id: 30, name: "KAMILA NEVES BRITO", email: "00001122109829SP@al.educacao.sp.gov.br" },
 { id: 33, name: "KEMILLY VITORIA RODRIGUES MARIANO", email: "00001122119781SP@al.educacao.sp.gov.br" },
 { id: 34, name: "LAURA LUIZA DOS SANTOS ALMEIDA", email: "00001141686442SP@al.educacao.sp.gov.br" },
 { id: 37, name: "MARIA EDUARDA VENCESLAU DE SOUZA", email: "00001123918867SP@al.educacao.sp.gov.br" },
 { id: 38, name: "MATHEUS CAVALCANTE LISBOA", email: "00001122175759SP@al.educacao.sp.gov.br" },
 { id: 40, name: "MURILLO SOUZA RODRIGUES DOS SANTOS", email: "00001122296228SP@al.educacao.sp.gov.br" },
 { id: 45, name: "PEDRO HENRIQUE MAURICIO DA SILVA CHAGAS", email: "00001140937571SP@al.educacao.sp.gov.br" },
 { id: 48, name: "RHUAN LIMA OLIVEIRA", email: "00001122272169SP@al.educacao.sp.gov.br" },
 { id: 49, name: "THAINA FIDELIS XAVIER DA SILVA", email: "00001122229148SP@al.educacao.sp.gov.br" },
 { id: 54, name: "DENIS CASTRO DURVALDO", email: "00001132474152SP@al.educacao.sp.gov.br" },
 { id: 56, name: "ISAAC LEMOS SANTOS", email: "00001141548744SP@al.educacao.sp.gov.br" },
 { id: 57, name: "EMILLY EDUARDA BONIFACIO DE AMORIM CORREA", email: "00001141568111SP@al.educacao.sp.gov.br" },
 { id: 58, name: "RAYSSA GUBEREV FRAGA", email: "00001114029373SP@al.educacao.sp.gov.br" },
 { id: 59, name: "LEONARDO ABADE DA SILVA DANTAS", email: "0000114154104XSP@al.educacao.sp.gov.br" },
 { id: 61, name: "MILENA CRISTINA LOPES DE CARVALHO", email: "00001122201436SP@al.educacao.sp.gov.br" },
 { id: 62, name: "PYETRA GOMES MARTINS", email: "00001141681717SP@al.educacao.sp.gov.br" },
 { id: 63, name: "MIRELLA BRITO DA SILVA", email: "00001122266224SP@al.educacao.sp.gov.br" },
 { id: 64, name: "CARLOS EDUARDO MARTINS DA SILVA", email: "00001141492003SP@al.educacao.sp.gov.br" },
 { id: 66, name: "STELLA MARTINS DA SILVA", email: "0000112231937XSP@al.educacao.sp.gov.br" },
 { id: 67, name: "DYESSICA MAYARA DOS SANTOS GOMES", email: "00001141700888SP@al.educacao.sp.gov.br" },
 { id: 68, name: "LARISSA DE LOURDES DOS SANTOS", email: "00001122136869SP@al.educacao.sp.gov.br" },
 { id: 70, name: "GUSTAVO RODRIGUES DE SOUZA", email: "00001132106084SP@al.educacao.sp.gov.br" },
 { id: 71, name: "PAULO HENRIQUE SOUZA MARTELO", email: "00001141508576SP@al.educacao.sp.gov.br" },
 { id: 72, name: "NAYARA BARROS DE MORAIS", email: "00001141532232SP@al.educacao.sp.gov.br" },
 { id: 73, name: "VITÓRIA SANTOS TEIXEIRA", email: "00001111267923SP@al.educacao.sp.gov.br" },
 { id: 74, name: "BRUNA VITORIA DA MOTA OLIVEIRA", email: "00001104893149SP@al.educacao.sp.gov.br" },
 { id: 75, name: "JOÃO PAULO RODRIGUES DE SOUZA FILHO", email: "00001122178013SP@al.educacao.sp.gov.br" },
 { id: 76, name: "MARIA EDUARDA DE OLIVEIRA RODRIGUES", email: "00001122177574SP@al.educacao.sp.gov.br" },
 { id: 77, name: "LUIZ HENRIQUE JESUS DOS SANTOS FABRICIO", email: "00001101285746SP@al.educacao.sp.gov.br" },
 { id: 78, name: "EDUARDO CARRASCOSA PINTOR", email: "00001132133828SP@al.educacao.sp.gov.br" },
 { id: 79, name: "GUILHERME DANIEL VELOSO DOS SANTOS", email: "00001132176281SP@al.educacao.sp.gov.br" },
 { id: 80, name: "JOAO GABRIEL AMORIM TOBIAS", email: "00001141428611SP@al.educacao.sp.gov.br" },
 { id: 81, name: "RIAN SANTOS MACHADO", email: "00001132118074SP@al.educacao.sp.gov.br" },
 { id: 82, name: "JULIA ARAUJO DE LIMA", email: "00001101366886SP@al.educacao.sp.gov.br" }
];

/* === QUESTÕES (SEM GABARITO embutido) === */
const allQuestions = [
  {
    id:1,
    question:`Em um ecossistema de Mata Atlântica, pesquisadores estudaram as interações entre produtores, consumidores e decompositores. Eles observaram que as teias alimentares eram complexas, com múltiplas conexões entre diferentes espécies. Considerando o fluxo de energia nesse ecossistema, qual das seguintes afirmações melhor explica por que a quantidade de energia disponível diminui a cada nível trófico?`,
    options:[
      {id:'a', text:'Os produtores retêm a maior parte da energia para seu próprio crescimento e manutenção, transferindo apenas uma pequena fração.'},
      {id:'b', text:'A energia é perdida principalmente na forma de calor durante os processos metabólicos, como a respiração celular, que ocorre em todos os organismos.'},
      {id:'c', text:'A energia é perdida devido à competição interespecífica dentro de cada nível trófico, reduzindo a eficiência da transferência.'},
      {id:'d', text:'Os decompositores consomem a maior parte da energia antes que ela possa ser transferida para os níveis tróficos superiores.'}
    ],
    explanation:`A segunda lei da termodinâmica explica que em cada transformação de energia parte é dissipada como calor. Nos ecossistemas, a respiração celular converte parte da energia em calor, limitando a transferência para níveis superiores.`
  },
  {
    id:2,
    question:`O ciclo do carbono é fundamental para a manutenção da vida na Terra. Durante uma aula de campo, estudantes observaram diferentes processos envolvidos neste ciclo. Considerando as atividades humanas contemporâneas, qual das seguintes alternativas representa o impacto mais significativo no aumento da concentração de CO₂ atmosférico?`,
    options:[
      {id:'a', text:'A decomposição da matéria orgânica em aterros sanitários e a fermentação entérica em rebanhos bovinos.'},
      {id:'b', text:'A respiração aeróbica de todos os organismos heterotróficos e a liberação de carbono durante erupções vulcânicas.'},
      {id:'c', text:'A produção de cimento e a aplicação de fertilizantes nitrogenados na agricultura intensiva.'},
      {id:'d', text:'A queima de combustíveis fósseis e as mudanças no uso do solo, como o desmatamento de florestas tropicais.'}
    ],
    explanation:`A queima de combustíveis fósseis e o desmatamento são as principais contribuições humanas para o aumento do CO₂ atmosférico.`
  },
  {
    id:3,
    question:`Em uma investigação sobre o ciclo do nitrogênio, um grupo de alunos analisou o papel de diferentes microorganismos. Eles descobriram que certas bactérias realizam processos essenciais para convertir o nitrogênio atmosférico em formas utilizáveis pelas plantas. Qual das seguintes afirmações melhor descreve a importância ecológica da fixação biológica de nitrogênio?`,
    options:[
      {id:'a', text:'Os fungos micorrízicos estabelecem simbiose com plantas, facilitando a absorção de compostos nitrogenados do solo.'},
      {id:'b', text:'As cianobactérias e rizóbios convertem o N₂ atmosférico em amônia, tornando o nitrogênio acessível aos produtores primários.'},
      {id:'c', text:'As bactérias nitrificantes convertem amônia em nitrito e depois em nitrato, formas mais facilmente absorvidas pelas raízes das plantas.'},
      {id:'d', text:'As bactérias desnitrificantes devolvem o nitrogênio à atmosfera, completando o ciclo e mantendo o equilíbrio ecológico.'}
    ],
    explanation:`A fixação biológica é realizada por rizóbios e cianobactérias que convertem N₂ em amônia utilizável pelas plantas.`
  },
  {
    id:4,
    question:`Um agricultor está decidindo entre usar fertilizantes orgânicos ou inorgânicos em sua plantação. Ele considera fatores como impacto ambiental, custo-benefício e efeitos a longo prazo na saúde do solo. Qual das seguintes vantagens está mais associada ao uso de fertilizantes orgânicos em comparação com os inorgânicos?`,
    options:[
      {id:'a', text:'Melhoria da estrutura do solo, aumento da capacidade de retenção de água e estímulo à atividade microbiana benéfica.'},
      {id:'b', text:'Liberação imediata e concentrada de nutrientes, permitindo correção rápida de deficiências nutricionais nas plantas.'},
      {id:'c', text:'Maior facilidade de aplicação e dosagem precisa dos macronutrientes necessários para o crescimento vegetal.'},
      {id:'d', text:'Maior concentração de nutrientes por unidade de peso, reduzindo custos de transporte e armazenamento.'}
    ],
    explanation:`Fertilizantes orgânicos melhoram a estrutura física e biológica do solo, retendo água e favorecendo microrganismos.`
  },
  {
    id:5,
    question:`A eutrofização é um processo que ocorre em ecossistemas aquáticos quando há excesso de nutrientes, principalmente nitrogênio e fósforo. Durante uma pesquisa em um lago eutrofizado, cientistas observaram uma série de alterações. Qual das seguintes sequências melhor descreve os eventos típicos do processo de eutrofização?`,
    options:[
      {id:'a', text:'Aumento de temperatura → aceleração do metabolismo → maior consumo de oxigênio → morte de organismos sensíveis → liberação de toxinas → redução da biodiversidade.'},
      {id:'b', text:'Acidificação da água → dissolução de metais pesados → toxicidade para organismos aquáticos → bioacumulação → desequilíbrio ecológico.'},
      {id:'c', text:'Acúmulo de sedimentos → assoreamento → redução da profundidade → aumento da temperatura → alteração nas comunidades biológicas.'},
      {id:'d', text:'Aumento de nutrientes → proliferação de algas → bloqueio da luz solar → morte de plantas aquáticas → decomposição → consumo de oxigênio → morte de peixes.'}
    ],
    explanation:`Excesso de nutrientes causa proliferação de algas; decomposição consome oxigênio, levando à morte de peixes.`
  },
  {
    id:6,
    question:`Em uma aula prática sobre fotossíntese, alunos investigaram como diferentes fatores ambientais afetam a taxa desse processo. Eles montaram um experimento com plantas aquáticas e observaram a liberação de bolhas de oxigênio sob diferentes condições. Qual das seguintes variáveis afeta diretamente a fase fotoquímica da fotossíntese?`,
    options:[
      {id:'a', text:'A concentração de ATP e NADPH, que são produtos da fase clara e essenciais para as reações de fixação de carbono.'},
      {id:'b', text:'A disponibilidade de CO₂ no meio, que é o substrato principal para a fixação de carbono no ciclo de Calvin.'},
      {id:'c', text:'A temperatura do ambiente, que influencia a atividade enzimática envolvida nas reações bioquímicas do processo.'},
      {id:'d', text:'A intensidade luminosa, que fornece a energia necessária para excitar elétrons e iniciar o transporte de elétrons fotossintético.'}
    ],
    explanation:`A fase fotoquímica depende diretamente da luz; a intensidade luminosa excita elétrons e inicia o transporte.`
  },
  {
    id:7,
    question:`O aquecimento global tem impactado significativamente os ecossistemas marinhos. Pesquisadores estudam os efeitos do aumento de CO₂ atmosférico nos oceanos, incluindo a acidificação. Qual das seguintes afirmações melhor explica a relação entre o aumento de CO₂ atmosférico e a acidificação dos oceanos?`,
    options:[
      {id:'a', text:'O derretimento das calotas polares libera água doce com pH naturalmente mais ácido, alterando a química oceânica.'},
      {id:'b', text:'As chuvas ácidas, resultantes da poluição industrial, são a principal causa da acidificação dos oceanos.'},
      {id:'c', text:'O aumento da temperatura global acelera a decomposição da matéria orgânica nos oceanos, liberando ácidos orgânicos.'},
      {id:'d', text:'O CO₂ atmosférico dissolve-se diretamente na água do mar, formando ácido carbônico que diminui o pH oceânico.'}
    ],
    explanation:`Quando o CO₂ se dissolve na água do mar forma ácido carbônico, aumentando H+ e reduzindo o pH (acidificação).`
  },
  {
    id:8,
    question:`Em um ecossistema de cerrado, pesquisadores estudaram as adaptações das plantas às condições de solo ácido e pobre em nutrientes. Eles observaram que muitas plantas desenvolveram estratégias específicas para obter nutrientes. Qual das seguintes adaptações está mais diretamente relacionada à aquisição de fósforo em solos com pH baixo?`,
    options:[
      {id:'a', text:'O desenvolvimento de tricomas foliares especializados na absorção de nutrientes a partir da água da chuva.'},
      {id:'b', text:'A produção de compostos alelopáticos que inibem a crescimento de plantas competidoras, reduzindo a competição por recursos.'},
      {id:'c', text:'A formação de raízes aéreas que absorvem nutrientes diretamente da atmosfera através de finas películas radiculares.'},
      {id:'d', text:'O estabelecimento de associações simbióticas com fungos micorrízicos que aumentam a superfície de absorção radicular.'}
    ],
    explanation:`As micorrizas aumentam a área de absorção e ajudam na aquisição de fósforo em solos pobres e ácidos.`
  },
  {
    id:9,
    question:`A respiração celular é um processo fundamental para a produção de energia nos organismos aeróbicos. Em uma aula de laboratório, estudantes compararam a eficiência energética da respiração aeróbica com a fermentação. Qual das seguintes afirmações melhor explica a vantagem da respiração aeróbica em termos de produção de ATP?`,
    options:[
      {id:'a', text:'As enzimas envolvidas na respiração aeróbica têm maior afinidade pelos seus substratos, acelerando as reações metabólicas.'},
      {id:'b', text:'A respiração aeróbica produz intermediários metabólicos que podem ser utilizados em outras vias biossintéticas, aumentando a eficiência celular.'},
      {id:'c', text:'O oxigênio atua como aceptor final de elétrons de alto potencial redutor, permitindo a completa oxidação da glicose e máxima produção de ATP.'},
      {id:'d', text:'A respiração aeróbica utiliza uma variedade maior de substratos energéticos, incluindo carboidratos, lipídios e proteínas.'}
    ],
    explanation:`O oxigênio como aceptor final permite a completa oxidação da glicose e produção máxima de ATP.`
  },
  {
    id:10,
    question:`A biodiversidade é fundamental para a resiliência dos ecossistemas. Em um estudo de longo prazo, ecólogos observaram que ecossistemas com maior diversidade de espécies tendem a ser mais estáveis e resistentes a perturbações. Qual dos seguintes mecanismos melhor explica essa relação entre biodiversidade e estabilidade ecossistêmica?`,
    options:[
      {id:'a', text:'O aumento da competição interespecífica em ecossistemas diversos, que seleciona organismos mais eficientes e adaptados às condições ambientais.'},
      {id:'b', text:'A hipótese de redundância funcional, onde múltiplas espécies desempenham funções similares, garantindo que o ecossistema mantenha suas funções mesmo com a perda de algumas espécies.'},
      {id:'c', text:'O efeito de complementaridade, onde espécies diferentes utilizam recursos de maneira complementar, aumentando a eficiência geral do ecossistema.'},
      {id:'d', text:'A maior probabilidade de que ecossistemas diversos contenham espécies chave com influência desproporcional sobre a estrutura comunitária.'}
    ],
    explanation:`A redundância funcional garante que múltiplas espécies desempenhem papéis similares, preservando funções se algumas forem perdidas.`
  }
];

/* === CONFIGURAÇÕES === */
/* Substitua esta URL pelo seu WebApp do Apps Script (terminando em /exec) */
const backendUrl = 'https://script.google.com/macros/s/SEU_DEPLOY_EXEC/exec';

/* === RENDERIZAÇÃO E LÓGICA === */
let studentAnswers = {};
function initializePage(){
  const sel = document.getElementById('student-name');
  students.forEach(s => {
    const opt = document.createElement('option');
    opt.value = s.id;
    opt.textContent = s.name;
    sel.appendChild(opt);
  });
  sel.addEventListener('change', onStudentChange);
  renderQuestions();
  document.getElementById('submit-btn').addEventListener('click', onSubmit);
}
function onStudentChange(e){
  const id = e.target.value;
  const s = students.find(x => x.id == id);
  if(s){
    document.getElementById('student-number').value = s.id;
    document.getElementById('student-email').value = s.email;
  } else {
    document.getElementById('student-number').value = '';
    document.getElementById('student-email').value = '';
  }
}
function renderQuestions(){
  const container = document.getElementById('questions-container');
  container.innerHTML = '';
  allQuestions.forEach((q, idx) => {
    const wrap = document.createElement('div');
    wrap.className = 'question-container';
    let html = `<div class="question"><div class="question-text">${idx+1}. ${q.question}</div><div class="options">`;
    q.options.forEach(opt => {
      html += `<label class="option"><input type="radio" name="q${q.id}" value="${opt.id}"> ${opt.text}</label>`;
    });
    html += `</div></div>`;
    wrap.innerHTML = html;
    container.appendChild(wrap);
  });
}

/* === ENVIO: manda JSON ao backend e exibe feedback conforme retorno === */
async function onSubmit(){
  const sel = document.getElementById('student-name');
  if(!sel.value){
    alert('Por favor, selecione seu nome antes de enviar.');
    return;
  }
  // coleta respostas
  studentAnswers = {};
  allQuestions.forEach(q => {
    const chosen = document.querySelector(`input[name="q${q.id}"]:checked`);
    studentAnswers[q.id] = chosen ? chosen.value : null;
  });
  const unanswered = Object.values(studentAnswers).filter(v => v === null).length;
  if(unanswered > 0){
    if(!confirm(`Você deixou ${unanswered} questão(ões) sem resposta. Deseja enviar mesmo assim?`)) return;
  }

  // monta payload
  const studentId = document.getElementById('student-number').value;
  const studentObj = students.find(s => s.id == studentId);
  const payload = {
    studentName: studentObj ? studentObj.name : '',
    studentNumber: studentObj ? studentObj.id : '',
    studentEmail: studentObj ? studentObj.email : '',
    studentGrade: document.getElementById('student-grade').value || '',
    timestamp: new Date().toISOString(),
    answers: studentAnswers
  };

  // exibe loading e envia
  document.getElementById('loading').style.display = 'block';
  document.getElementById('submit-btn').disabled = true;

  try{
    const res = await fetch(backendUrl, {
      method: 'POST',
      headers: {'Content-Type':'application/json'},
      body: JSON.stringify(payload)
    });

    const text = await res.text();

    // tenta parsear JSON
    let json;
    try { json = JSON.parse(text); } catch(e){ json = null; }

    if(!res.ok){
      throw new Error('Resposta do servidor não é OK: ' + res.status);
    }

    // Caso backend retorne JSON com estrutura esperada:
    // { status: "OK", score: N, details: [{id:1, correct:true, explanation:"..."}, ...] }
    if(json && json.status && json.status.toUpperCase()==='OK'){
      displayResultsFromBackend(json);
    } else {
      // fallback: backend respondeu texto (ex: "OK" ou mensagem). Mostramos aviso e ainda acoplar feedback local sem gabarito:
      document.getElementById('loading').style.display = 'none';
      document.getElementById('submit-btn').disabled = false;
      alert('Respostas enviadas com sucesso. O servidor retornou: ' + text + '\nObservação: para receber a nota e feedback automático, publique um doPost que retorne JSON com o resultado.');
    }

  } catch(err){
    console.error(err);
    document.getElementById('loading').style.display = 'none';
    document.getElementById('submit-btn').disabled = false;
    alert('Ocorreu um erro ao enviar as respostas. Verifique o link do WebApp e as permissões. Erro: ' + err.message);
  }
}

function displayResultsFromBackend(json){
  // segurança: esconde loading
  document.getElementById('loading').style.display = 'none';
  document.getElementById('submit-btn').disabled = false;

  const scoreSpan = document.getElementById('score-value');
  scoreSpan.textContent = (typeof json.score === 'number') ? json.score : '0';

  const feedbackDiv = document.getElementById('feedback');
  feedbackDiv.innerHTML = '';

  // json.details deve ser array com objetos {id, correct, explanation (opcional)}
  if(Array.isArray(json.details)){
    json.details.forEach((d, idx) => {
      const q = allQuestions.find(x => x.id == d.id);
      const wasCorrect = !!d.correct;
      const userAnswer = (d.userAnswer !== undefined) ? d.userAnswer : (studentAnswers[d.id] || 'não respondida');

      let block = document.createElement('div');
      block.style.marginBottom = '10px';

      const line = document.createElement('p');
      line.innerHTML = `<strong>Questão ${idx+1}:</strong> ${wasCorrect ? "<span class='correct'>✓ Correta</span>" : "<span class='incorrect'>✗ Incorreta</span>"} <br><strong>Sua resposta:</strong> ${userAnswer}`;
      block.appendChild(line);

      if(!wasCorrect){
        // mostrar explicação (do objeto d.explanation do backend; se ausente, usar a explicação do front)
        const expl = d.explanation || (q ? q.explanation : '');
        if(expl){
          const p = document.createElement('p');
          p.style.marginTop = '6px';
          p.style.fontStyle = 'italic';
          p.textContent = expl;
          block.appendChild(p);
        }
      }

      feedbackDiv.appendChild(block);
    });
  } else {
    feedbackDiv.innerHTML = '<p>Feedback detalhado indisponível.</p>';
  }

  document.getElementById('results').style.display = 'block';
  window.scrollTo(0,document.body.scrollHeight);
}

/* Inicializa página */
window.addEventListener('DOMContentLoaded', initializePage);
</script>
</body>
</html>
